
name: Automated Figma To Theme Code

on:
    push:
        paths:
            - "tokens.json"

permissions:
    contents: write

jobs:
    generate-tokens:
        name: Generate Theme Code
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Verify tokens.json exists
              run: |
                  if [ ! -f "tokens.json" ]; then
                      echo "Error: tokens.json file not found"
                      exit 1
                  fi
                  echo "tokens.json found"
                  
                  # Verify it's valid JSON
                  if ! jq empty tokens.json 2>/dev/null; then
                      echo "tokens.json is valid JSON"
                      TOKEN_COUNT=$(jq 'length' tokens.json 2>/dev/null || echo "unknown")
                      echo "Token count: $TOKEN_COUNT"
                  else
                      echo "Warning: tokens.json may not be valid JSON"
                  fi

            - name: Pre-flight checks
              run: |
                  echo "Running pre-flight checks..."
                  echo "✓ Repository checked out"
                  echo "✓ tokens.json verified"
                  echo "Note: If action fails, verify THEME_DESIGNER_SECRET_KEY is configured in repository secrets"

            - name: Generate Prime Theme
              id: generate-theme
              timeout-minutes: 10
              continue-on-error: false
              uses: primefaces/theme-designer-ci@1.0.0-beta.4
              with:
                  designer-secret: ${{ secrets.THEME_DESIGNER_SECRET_KEY }}
                  theme-name: "Parts X primevue"
                  project: "primevue"
                  font-size: "14px"
                  font-family: "Inter Var"
                  tokens-path: "tokens.json"
                  output-dir: "./src/app/partsxprimevue"
              env:
                  ACTIONS_STEP_DEBUG: ${{ secrets.ACTIONS_STEP_DEBUG || 'false' }}

            - name: Check action exit status
              if: always()
              run: |
                  if [ "${{ steps.generate-theme.outcome }}" != "success" ]; then
                      echo "::error::Theme generation action failed or did not complete successfully"
                      echo "Action outcome: ${{ steps.generate-theme.outcome }}"
                      echo "Possible issues:"
                      echo "  - Invalid designer-secret"
                      echo "  - Network/timeout issues"
                      echo "  - Invalid tokens.json format"
                      echo "  - Theme designer service unavailable"
                      exit 1
                  fi
                  echo "✓ Theme generation action completed successfully"

            - name: Verify output files were generated
              run: |
                  if [ ! -d "./src/app/partsxprimevue" ]; then
                      echo "Error: Output directory does not exist"
                      exit 1
                  fi
                  
                  if [ ! -d "./src/app/partsxprimevue/js" ] && [ ! -d "./src/app/partsxprimevue/ts" ]; then
                      echo "Error: No JS or TS files were generated"
                      exit 1
                  fi
                  
                  # Check if at least some files exist
                  JS_COUNT=$(find ./src/app/partsxprimevue/js -name "*.js" 2>/dev/null | wc -l || echo "0")
                  TS_COUNT=$(find ./src/app/partsxprimevue/ts -name "*.ts" 2>/dev/null | wc -l || echo "0")
                  
                  if [ "$JS_COUNT" -eq 0 ] && [ "$TS_COUNT" -eq 0 ]; then
                      echo "Error: No theme files were generated (found 0 JS and 0 TS files)"
                      exit 1
                  fi
                  
                  echo "Successfully generated $JS_COUNT JS files and $TS_COUNT TS files"
